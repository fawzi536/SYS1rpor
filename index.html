<!doctype html>
<html lang="ar" dir="rtl" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap');
    
    * {
      font-family: 'Cairo', sans-serif;
    }
    
    .bg-gold {
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    }
    
    .text-gold {
      color: #F2BC1B;
    }
    
    .border-gold {
      border-color: #F2BC1B;
    }
    
    .card {
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      border-radius: 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
      border: none;
      transition: all 0.3s ease;
    }
    
    select, input {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #ffffff;
      transition: all 0.3s ease;
    }
    
    select:focus, input:focus {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(242, 188, 27, 0.3);
    }
    
    .spinner {
      border: 3px solid #333;
      border-top: 3px solid #F2BC1B;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .error-message {
      background: #fee2e2;
      border: 1px solid #fca5a5;
      color: #991b1b;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 16px 0;
    }
    
    .autocomplete-list {
      max-height: 250px;
      overflow-y: auto;
      border: none;
      border-radius: 12px;
      background: white;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.2);
    }
    
    .autocomplete-item {
      padding: 14px 20px;
      cursor: pointer;
      transition: all 0.2s ease;
      border-bottom: 1px solid #f0f0f0;
    }
    
    .autocomplete-item:hover {
      background: linear-gradient(135deg, #F2BC1B 0%, #ffd54f 100%);
      color: #1a1a1a;
      font-weight: 600;
      transform: translateX(-5px);
      padding-right: 25px;
    }
    
    .info-box {
      background: #dbeafe;
      border: 2px solid #3b82f6;
      color: #1e40af;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 12px 0;
      font-weight: 600;
    }
    
    .warning-box {
      background: #fef3c7;
      border: 2px solid #f59e0b;
      color: #92400e;
      padding: 12px 16px;
      border-radius: 8px;
      margin: 12px 0;
      font-weight: 600;
    }
    
    .result-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      border: 2px solid #F2BC1B;
      border-radius: 12px;
      overflow: hidden;
    }
    
    .result-table th {
      background: linear-gradient(135deg, #F2BC1B 0%, #d9a616 100%);
      color: #1a1a1a;
      padding: 12px;
      font-weight: 700;
      text-align: center;
      border-bottom: 2px solid #d9a616;
    }
    
    .result-table td {
      padding: 10px 12px;
      text-align: center;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .result-table tr:last-child td {
      border-bottom: none;
    }
    
    .hidden {
      display: none;
    }
    
    .wash-card {
      background: white;
      border: 2px solid #F2BC1B;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      transition: all 0.3s ease;
    }
    
    .wash-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(242, 188, 27, 0.3);
    }
    
    .wash-card h3 {
      color: #1a1a1a;
      font-size: 1.5rem;
      font-weight: 700;
      margin-bottom: 8px;
    }
    
    .wash-card .duration {
      color: #4b5563;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    
    .wash-card .price {
      color: #1a1a1a;
      font-size: 1.25rem;
      font-weight: 700;
      margin-bottom: 12px;
    }
    
    .wash-card ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .wash-card li {
      padding: 6px 0;
      padding-right: 20px;
      position: relative;
      color: #374151;
    }
    
    .wash-card li:before {
      content: "âœ“";
      position: absolute;
      right: 0;
      color: #16a34a;
      font-weight: bold;
    }
    
    .copy-btn {
      background: #1a1a1a;
      color: #F2BC1B;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s ease;
      margin-top: 12px;
      width: 100%;
    }
    
    .copy-btn:hover {
      background: #2d2d2d;
      transform: translateY(-2px);
    }
    
    .copy-btn:active {
      transform: translateY(0);
    }
    
    .copy-success {
      background: #16a34a !important;
      color: white !important;
    }
    
    .date-input {
      max-width: 300px;
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
 </head>
 <body class="h-full bg-gold">
  <div class="h-full w-full overflow-auto">
   <div class="min-h-full py-8 px-4">
    <div class="max-w-2xl mx-auto"><!-- Logo -->
     <div class="text-center mb-8"><img src="https://i.top4top.io/p_35860o72q1.png" alt="Ø´Ø¹Ø§Ø± Ø§Ù„Ø´Ø±ÙƒØ©" class="mx-auto mb-4" style="max-width: 200px; height: auto;">
      <h1 id="siteTitle" class="text-4xl font-bold mb-2" style="color: #F2BC1B; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬</h1>
     </div><!-- Initial Loading -->
     <div id="initialLoading" class="card p-8 mb-8">
      <div class="text-center py-8">
       <div class="spinner mx-auto"></div>
       <p class="text-gray-700 text-xl font-semibold mt-4">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
      </div>
     </div><!-- Main Form -->
     <div id="mainForm" class="card p-8 mb-8 hidden">
      <div class="space-y-6"><!-- Service Type Selection -->
       <div><label for="serviceTypeSelect" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø©</label> <select id="serviceTypeSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"> <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option> <option value="tow">ÙˆÙ†Ø´Ø§Øª</option> <option value="battery">Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ© - ÙØ­Øµ Ø¨Ø·Ø§Ø±ÙŠØ©</option> <option value="batteryInstall">ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©</option> <option value="fuel">Ø®Ø¯Ù…Ø© Ø¨Ù†Ø²ÙŠÙ†</option> <option value="tire">Ø®Ø¯Ù…Ø© Ø¨Ù†Ø´Ø±</option> <option value="balance">Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨</option> <option value="mechanical">Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©</option> <option value="carwash">ØºØ³ÙŠÙ„ Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª</option> </select>
       </div><!-- Dynamic Fields Container -->
       <div id="dynamicFields"></div>
      </div><!-- Error Message -->
      <div id="errorMessage" class="error-message hidden"></div><!-- Loading Spinner -->
      <div id="loadingSpinner" class="text-center py-4 hidden">
       <div class="spinner mx-auto"></div>
       <p class="text-white mt-2">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
      </div>
     </div><!-- Results Section -->
     <div id="resultsSection" class="hidden">
      <div class="card p-10">
       <div class="text-center mb-8">
        <h2 id="resultTitle" class="text-3xl font-bold bg-gradient-to-r from-gray-900 to-gray-700 bg-clip-text text-transparent mb-4"></h2>
       </div>
       <div id="resultContent" class="space-y-4"></div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      site_title: 'Ø®Ø¯Ù…Ø§Øª Ø¨ÙˆØ±ØªØ±Ø§Ø¬',
      sheet_id: '1x2ongtstODqEEWh_jAwN8zLHjsYeIppk8EH_Q1CXMzk',
      currency: 'Ø¯.Ùƒ'
    };

    let config = { ...defaultConfig };
    let sheetsData = {};

    // Initialize Element SDK
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange: async (newConfig) => {
          config = { ...defaultConfig, ...newConfig };
          document.getElementById('siteTitle').textContent = config.site_title;
          
          if (newConfig.sheet_id && newConfig.sheet_id !== sheetsData.currentSheetId) {
            await loadAllSheets();
          }
        },
        mapToCapabilities: () => ({
          recolorables: [],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (cfg) => new Map([
          ['site_title', cfg.site_title || defaultConfig.site_title],
          ['sheet_id', cfg.sheet_id || defaultConfig.sheet_id],
          ['currency', cfg.currency || defaultConfig.currency]
        ])
      });
    }

    // DOM Elements
    const initialLoading = document.getElementById('initialLoading');
    const mainForm = document.getElementById('mainForm');
    const serviceTypeSelect = document.getElementById('serviceTypeSelect');
    const dynamicFields = document.getElementById('dynamicFields');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const errorMessage = document.getElementById('errorMessage');
    const resultsSection = document.getElementById('resultsSection');
    const resultTitle = document.getElementById('resultTitle');
    const resultContent = document.getElementById('resultContent');

    // State
    let currentService = '';
    let formData = {};
    let carWashData = [];
    
    // Company mapping (Arabic display names to sheet names)
    const companyMapping = {
      'Ø¨ÙˆØ±ØªØ±Ø§Ø¬': 'portarage towtruk',
      'Ù‡ÙŠØ±Ùˆ ÙˆØ±ÙƒØ³': 'hero.works',
      'Ø£Ø­Ù…Ø¯ Ø§Ù„ØºØ§Ù†Ù…': 'Ahmed Al-Ghanem',
      'Ø¨ÙŠÙƒÙˆÙƒ ÙƒÙˆÙ†Ø³ÙŠØ±Ø¬': 'Peacock Concierge',
      'Ø¨Ø±ÙˆØ¬ÙƒØª Ø¥ÙƒØ³ Ø±ÙŠØ³Ù†Ù‚': 'ProjX Racing',
      'ÙŠØ§Ù…Ø§Ù‡Ø§ Ù…ÙˆØªÙˆØ±': 'Yamaha Motor',
      'ÙÙˆÙ„Øª Ù‚Ø§Ø±Ø§Ø¬': 'Vault Garage',
      'Ø¬ÙŠÙ„ÙŠ': 'Geely',
      'Ø§ÙˆØªÙˆ ÙƒØ§Ø¨ÙŠØªØ§Ù„': 'Auto Capital'
    };
    
    const companies = Object.keys(companyMapping);

    // Parse CSV
    function parseCSV(csvText) {
      const rows = [];
      const lines = csvText.split('\n');
      
      for (let line of lines) {
        if (!line.trim()) continue;
        
        const cells = [];
        let cell = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          
          if (char === '"') {
            if (inQuotes && line[i + 1] === '"') {
              cell += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === ',' && !inQuotes) {
            cells.push(cell.replace(/^"|"$/g, ''));
            cell = '';
          } else {
            cell += char;
          }
        }
        cells.push(cell.replace(/^"|"$/g, ''));
        rows.push(cells);
      }
      
      return rows;
    }

    // Load all sheets
    async function loadAllSheets() {
      try {
        showError('');
        const sheetId = config.sheet_id;
        
        const sheetNames = [
          'portarage towtruk',
          'hero.works',
          'Ahmed Al-Ghanem',
          'Peacock Concierge',
          'ProjX Racing',
          'Yamaha Motor',
          'Vault Garage',
          'Geely',
          'Auto Capital',
          'Ø®Ø¯Ù…Ø§Øª5',
          'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨',
          'Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©',
          'ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©'
        ];
        
        sheetsData = { currentSheetId: sheetId };
        
        for (const sheetName of sheetNames) {
          try {
            const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(sheetName)}`;
            const response = await fetch(csvUrl);
            
            if (response.ok) {
              const csvText = await response.text();
              const rows = parseCSV(csvText);
              sheetsData[sheetName] = rows;
            }
          } catch (err) {
            console.log(`Could not load sheet: ${sheetName}`);
          }
        }
        
        // Show main form after loading
        if (initialLoading && mainForm) {
          initialLoading.classList.add('hidden');
          mainForm.classList.remove('hidden');
        }
        
      } catch (error) {
        showError('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
        if (initialLoading && mainForm) {
          initialLoading.classList.add('hidden');
          mainForm.classList.remove('hidden');
        }
      }
    }

    // Service Type Change Handler
    serviceTypeSelect.addEventListener('change', () => {
      currentService = serviceTypeSelect.value;
      formData = {};
      dynamicFields.innerHTML = '';
      resultsSection.classList.add('hidden');
      showError('');
      
      if (!currentService) return;
      
      switch(currentService) {
        case 'tow':
          renderTowFields();
          break;
        case 'battery':
          renderBatteryFields();
          break;
        case 'batteryInstall':
          renderBatteryInstallFields();
          break;
        case 'fuel':
          renderFuelFields();
          break;
        case 'tire':
          renderTireFields();
          break;
        case 'balance':
          renderBalanceFields();
          break;
        case 'mechanical':
          renderMechanicalFields();
          break;
        case 'carwash':
          renderCarWashFields();
          break;
      }
    });

    // Render Tow Service Fields
    function renderTowFields() {
      const html = `
        <div>
          <label for="companyInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ø®ØªØ± Ø§Ù„Ø¬Ù‡Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="companyInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¬Ù‡Ø©..."
              autocomplete="off"
              value="Ø¨ÙˆØ±ØªØ±Ø§Ø¬"
            >
            <div id="companySuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>

        <div id="towTypeContainer" class="hidden">
          <label for="towTypeSelect" class="block text-lg font-semibold text-gray-900 mb-2">Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ†Ø´</label>
          <select id="towTypeSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ†Ø´</option>
          </select>
        </div>

        <div id="fromContainer" class="hidden">
          <label for="fromInput" class="block text-lg font-semibold text-gray-900 mb-2">Ù…Ù† Ø£ÙŠÙ†</label>
          <div class="relative">
            <input 
              type="text" 
              id="fromInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ†Ø´ Ø£ÙˆÙ„Ø§Ù‹"
              autocomplete="off"
              disabled
            >
            <div id="fromSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>

        <div id="toContainer" class="hidden">
          <label for="toInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø¥Ù„Ù‰ Ø£ÙŠÙ†</label>
          <div class="relative">
            <input 
              type="text" 
              id="toInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø£ÙˆÙ„"
              autocomplete="off"
              disabled
            >
            <div id="toSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>

        <div id="extraChargesContainer" class="hidden">
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ù‡Ù„ Ø§Ù„Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´ Ø£Ùˆ Ø§Ù„Ø³ÙŠØ§Ø±Ø© ÙÙŠÙ‡Ø§ Ø­Ø§Ø¯Ø«ØŸ</label>
          <select id="extraChargesSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù… (+10 Ø¯.Ùƒ Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª)</option>
          </select>
          <div id="extraChargesNote" class="warning-box hidden" style="margin-top: 12px;">
            <strong>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø© Ù…Ù‡Ù…Ø©:</strong><br>
            ÙŠÙ…ÙƒÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠÙˆØ¯ÙŠ Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ù…Ø®ÙØ±. ÙÙŠ Ø­Ø§Ù„ Ø§Ù„ÙˆÙ†Ø´ Ø±Ø§Ø­ ÙŠÙ†ØªØ¸Ø± Ø§Ù„Ù…Ø®ÙØ±ØŒ ÙÙŠ Ø±Ø³ÙˆÙ… Ø§Ù†ØªØ¸Ø§Ø±:<br>
            â€¢ 5 Ø¯.Ùƒ Ù„ÙƒÙ„ Ù†ØµÙ Ø³Ø§Ø¹Ø©<br>
            â€¢ 10 Ø¯.Ùƒ Ù„ÙƒÙ„ Ø³Ø§Ø¹Ø©
          </div>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      
      // Set default company to Ø¨ÙˆØ±ØªØ±Ø§Ø¬
      formData.company = companyMapping['Ø¨ÙˆØ±ØªØ±Ø§Ø¬'];
      formData.companyArabic = 'Ø¨ÙˆØ±ØªØ±Ø§Ø¬';
      
      initTowAutocomplete();
    }

    // Initialize Tow Autocomplete
    function initTowAutocomplete() {
      const companyInput = document.getElementById('companyInput');
      const companySuggestions = document.getElementById('companySuggestions');
      const towTypeContainer = document.getElementById('towTypeContainer');
      const towTypeSelect = document.getElementById('towTypeSelect');
      const fromContainer = document.getElementById('fromContainer');
      const fromInput = document.getElementById('fromInput');
      const fromSuggestions = document.getElementById('fromSuggestions');
      const toContainer = document.getElementById('toContainer');
      const toInput = document.getElementById('toInput');
      const toSuggestions = document.getElementById('toSuggestions');
      
      let availableFromLocations = [];
      let availableToLocations = [];
      
      // Initialize with default company
      updateTowTypeOptions();
      
      // Company autocomplete
      companyInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (!searchTerm) {
          companySuggestions.classList.add('hidden');
          return;
        }
        
        const matches = companies.filter(c => c.toLowerCase().includes(searchTerm));
        
        if (matches.length === 0) {
          companySuggestions.classList.add('hidden');
          return;
        }
        
        companySuggestions.innerHTML = '';
        matches.forEach(company => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = company;
          div.addEventListener('click', () => {
            companyInput.value = company;
            formData.company = companyMapping[company];
            formData.companyArabic = company;
            companySuggestions.classList.add('hidden');
            updateTowTypeOptions();
          });
          companySuggestions.appendChild(div);
        });
        
        companySuggestions.classList.remove('hidden');
        
        const exactMatch = companies.find(c => c.toLowerCase() === searchTerm);
        if (exactMatch) {
          formData.company = companyMapping[exactMatch];
          formData.companyArabic = exactMatch;
          updateTowTypeOptions();
        }
      });
      
      // Show all companies on click
      companyInput.addEventListener('click', () => {
        companySuggestions.innerHTML = '';
        companies.forEach(company => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = company;
          div.addEventListener('click', () => {
            companyInput.value = company;
            formData.company = companyMapping[company];
            formData.companyArabic = company;
            companySuggestions.classList.add('hidden');
            updateTowTypeOptions();
          });
          companySuggestions.appendChild(div);
        });
        companySuggestions.classList.remove('hidden');
      });
      
      // Update tow type options based on company
      function updateTowTypeOptions() {
        const sheetName = formData.company;
        if (!sheetName || !sheetsData[sheetName]) {
          towTypeContainer.classList.add('hidden');
          return;
        }
        
        const rows = sheetsData[sheetName];
        const hasNormal = checkIfTowTypeHasData(rows, 'normal');
        const hasFlatbed = checkIfTowTypeHasData(rows, 'flatbed');
        
        towTypeSelect.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ÙˆÙ†Ø´</option>';
        
        if (hasNormal) {
          towTypeSelect.innerHTML += '<option value="normal">ÙˆÙ†Ø´ Ø¹Ø§Ø¯ÙŠ</option>';
        }
        if (hasFlatbed) {
          towTypeSelect.innerHTML += '<option value="flatbed">ÙˆÙ†Ø´ ÙÙ„ Ø¯Ø§ÙˆÙ†</option>';
        }
        
        if (hasNormal || hasFlatbed) {
          towTypeContainer.classList.remove('hidden');
        }
        
        fromContainer.classList.add('hidden');
        toContainer.classList.add('hidden');
        document.getElementById('extraChargesContainer').classList.add('hidden');
        resultsSection.classList.add('hidden');
      }
      
      // Check if tow type has data
      function checkIfTowTypeHasData(rows, towType) {
        if (!rows || rows.length < 3) return false;
        
        for (let i = 2; i < rows.length; i++) {
          const row = rows[i];
          if (towType === 'normal') {
            if (row[6] && (row[5] || row[2])) return true;
          } else if (towType === 'flatbed') {
            if (row[14] && (row[13] || row[10])) return true;
          }
        }
        return false;
      }
      
      // Tow type change
      towTypeSelect.addEventListener('change', () => {
        formData.towType = towTypeSelect.value;
        
        if (!formData.towType) {
          fromContainer.classList.add('hidden');
          toContainer.classList.add('hidden');
          document.getElementById('extraChargesContainer').classList.add('hidden');
          resultsSection.classList.add('hidden');
          return;
        }
        
        const routes = getTowRoutes(formData.company, formData.towType);
        availableFromLocations = [...new Set(routes.map(r => r.from))].filter(Boolean);
        
        fromInput.disabled = false;
        fromInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
        fromInput.value = '';
        formData.from = '';
        
        toInput.disabled = true;
        toInput.value = '';
        formData.to = '';
        
        fromContainer.classList.remove('hidden');
        toContainer.classList.add('hidden');
        document.getElementById('extraChargesContainer').classList.add('hidden');
        resultsSection.classList.add('hidden');
      });
      
      // From autocomplete
      fromInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (!searchTerm) {
          fromSuggestions.classList.add('hidden');
          formData.from = '';
          toContainer.classList.add('hidden');
          document.getElementById('extraChargesContainer').classList.add('hidden');
          resultsSection.classList.add('hidden');
          return;
        }
        
        const matches = availableFromLocations.filter(loc => loc.toLowerCase().includes(searchTerm));
        
        if (matches.length === 0) {
          fromSuggestions.classList.add('hidden');
          return;
        }
        
        fromSuggestions.innerHTML = '';
        matches.forEach(loc => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = loc;
          div.addEventListener('click', () => {
            fromInput.value = loc;
            formData.from = loc;
            fromSuggestions.classList.add('hidden');
            updateToLocations();
          });
          fromSuggestions.appendChild(div);
        });
        
        fromSuggestions.classList.remove('hidden');
        
        const exactMatch = availableFromLocations.find(l => l.toLowerCase() === searchTerm);
        if (exactMatch) {
          formData.from = exactMatch;
          updateToLocations();
        }
      });
      
      // Show all from locations on click
      fromInput.addEventListener('click', () => {
        if (availableFromLocations.length > 0 && !fromInput.disabled) {
          fromSuggestions.innerHTML = '';
          availableFromLocations.forEach(loc => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = loc;
            div.addEventListener('click', () => {
              fromInput.value = loc;
              formData.from = loc;
              fromSuggestions.classList.add('hidden');
              updateToLocations();
            });
            fromSuggestions.appendChild(div);
          });
          fromSuggestions.classList.remove('hidden');
        }
      });
      
      // Update to locations
      function updateToLocations() {
        if (!formData.from) return;
        
        const routes = getTowRoutes(formData.company, formData.towType);
        availableToLocations = [...new Set(routes.filter(r => r.from === formData.from).map(r => r.to))].filter(Boolean);
        
        toInput.disabled = false;
        toInput.placeholder = 'Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹...';
        toInput.value = '';
        formData.to = '';
        
        toContainer.classList.remove('hidden');
        document.getElementById('extraChargesContainer').classList.add('hidden');
        resultsSection.classList.add('hidden');
      }
      
      // To autocomplete
      toInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (!searchTerm) {
          toSuggestions.classList.add('hidden');
          formData.to = '';
          resultsSection.classList.add('hidden');
          document.getElementById('extraChargesContainer').classList.add('hidden');
          return;
        }
        
        const matches = availableToLocations.filter(loc => loc.toLowerCase().includes(searchTerm));
        
        if (matches.length === 0) {
          toSuggestions.classList.add('hidden');
          return;
        }
        
        toSuggestions.innerHTML = '';
        matches.forEach(loc => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = loc;
          div.addEventListener('click', () => {
            toInput.value = loc;
            formData.to = loc;
            toSuggestions.classList.add('hidden');
            
            // Show extra charges question only for portarage
            if (formData.company && formData.company.toLowerCase() === 'portarage towtruk') {
              const extraChargesContainer = document.getElementById('extraChargesContainer');
              extraChargesContainer.classList.remove('hidden');
              
              // Set up event listener for extra charges
              const extraChargesSelect = document.getElementById('extraChargesSelect');
              const extraChargesNote = document.getElementById('extraChargesNote');
              formData.extraCharges = 'no';
              extraChargesSelect.value = 'no';
              extraChargesNote.classList.add('hidden');
              
              extraChargesSelect.addEventListener('change', () => {
                formData.extraCharges = extraChargesSelect.value;
                
                // Show/hide warning note
                if (formData.extraCharges === 'yes') {
                  extraChargesNote.classList.remove('hidden');
                } else {
                  extraChargesNote.classList.add('hidden');
                }
                
                calculateAndShowResult();
              });
              
              calculateAndShowResult();
            } else {
              calculateAndShowResult();
            }
          });
          toSuggestions.appendChild(div);
        });
        
        toSuggestions.classList.remove('hidden');
        
        const exactMatch = availableToLocations.find(l => l.toLowerCase() === searchTerm);
        if (exactMatch) {
          formData.to = exactMatch;
          
          // Show extra charges question only for portarage
          if (formData.company && formData.company.toLowerCase() === 'portarage towtruk') {
            const extraChargesContainer = document.getElementById('extraChargesContainer');
            extraChargesContainer.classList.remove('hidden');
            
            // Set up event listener for extra charges
            const extraChargesSelect = document.getElementById('extraChargesSelect');
            const extraChargesNote = document.getElementById('extraChargesNote');
            formData.extraCharges = 'no';
            extraChargesSelect.value = 'no';
            extraChargesNote.classList.add('hidden');
            
            extraChargesSelect.addEventListener('change', () => {
              formData.extraCharges = extraChargesSelect.value;
              
              // Show/hide warning note
              if (formData.extraCharges === 'yes') {
                extraChargesNote.classList.remove('hidden');
              } else {
                extraChargesNote.classList.add('hidden');
              }
              
              calculateAndShowResult();
            });
            
            calculateAndShowResult();
          } else {
            calculateAndShowResult();
          }
        }
      });
      
      // Show all to locations on click
      toInput.addEventListener('click', () => {
        if (availableToLocations.length > 0 && !toInput.disabled) {
          toSuggestions.innerHTML = '';
          availableToLocations.forEach(loc => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = loc;
            div.addEventListener('click', () => {
              toInput.value = loc;
              formData.to = loc;
              toSuggestions.classList.add('hidden');
              
              // Show extra charges question only for portarage
              if (formData.company && formData.company.toLowerCase() === 'portarage towtruk') {
                const extraChargesContainer = document.getElementById('extraChargesContainer');
                extraChargesContainer.classList.remove('hidden');
                
                // Set up event listener for extra charges
                const extraChargesSelect = document.getElementById('extraChargesSelect');
                const extraChargesNote = document.getElementById('extraChargesNote');
                formData.extraCharges = 'no';
                extraChargesSelect.value = 'no';
                extraChargesNote.classList.add('hidden');
                
                extraChargesSelect.addEventListener('change', () => {
                  formData.extraCharges = extraChargesSelect.value;
                  
                  // Show/hide warning note
                  if (formData.extraCharges === 'yes') {
                    extraChargesNote.classList.remove('hidden');
                  } else {
                    extraChargesNote.classList.add('hidden');
                  }
                  
                  calculateAndShowResult();
                });
                
                calculateAndShowResult();
              } else {
                calculateAndShowResult();
              }
            });
            toSuggestions.appendChild(div);
          });
          toSuggestions.classList.remove('hidden');
        }
      });
      
      // Hide suggestions on outside click
      document.addEventListener('click', (e) => {
        if (!companySuggestions.contains(e.target) && e.target !== companyInput) {
          companySuggestions.classList.add('hidden');
        }
        if (!fromSuggestions.contains(e.target) && e.target !== fromInput) {
          fromSuggestions.classList.add('hidden');
        }
        if (!toSuggestions.contains(e.target) && e.target !== toInput) {
          toSuggestions.classList.add('hidden');
        }
      });
    }
    
    // Get tow routes
    function getTowRoutes(sheetName, towType) {
      const rows = sheetsData[sheetName];
      if (!rows || rows.length < 3) return [];
      
      const routes = [];
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        if (towType === 'normal') {
          const from = row[6];
          const toF = row[5];
          const toC = row[2];
          const priceE = row[4];
          const priceB = row[1];
          
          if (from && toF && priceE) {
            routes.push({ from, to: toF, price: priceE });
          }
          if (from && toC && priceB) {
            routes.push({ from, to: toC, price: priceB });
          }
        } else if (towType === 'flatbed') {
          const from = row[14];
          const toN = row[13];
          const toK = row[10];
          const priceM = row[12];
          const priceJ = row[9];
          
          if (from && toN && priceM) {
            routes.push({ from, to: toN, price: priceM });
          }
          if (from && toK && priceJ) {
            routes.push({ from, to: toK, price: priceJ });
          }
        }
      }
      
      return routes;
    }

    // Render Battery Fields
    function renderBatteryFields() {
      const html = `
        <div>
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
        
        <div class="info-box" style="background: #dbeafe; border-color: #3b82f6; color: #1e40af;">
          <strong>ğŸ’¡ Ù…Ù„Ø§Ø­Ø¸Ø©:</strong> ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙŠØ¨ÙŠ ÙØ­Øµ Ø¨Ø·Ø§Ø±ÙŠØ©ØŒ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ§Øª Ù…ØªÙˆÙØ±Ø© Ø¹Ù†Ø¯Ù†Ø§. Ù„Ø§Ø²Ù… ØªØ¨Ù„ØºÙˆÙ† Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£Ù†Ù‡ 10 Ø¯.Ùƒ ØªÙ†Ø®ØµÙ… Ù…Ù† Ø³Ø¹Ø± Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ©.
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      
      const batteryResultCallback = function() {
        calculateAndShowResult();
      };
      
      initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], batteryResultCallback);
    }

    // Render Battery Install Fields
    function renderBatteryInstallFields() {
      const html = `
        <div>
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      initAreaAutocomplete('ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©', [0, 1, 2, 4, 5, 6], calculateAndShowResult);
    }

    // Render Fuel Fields
    function renderFuelFields() {
      const html = `
        <div>
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
        
        <div id="fuelTypeContainer" class="hidden">
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ø£ÙŠ Ù†ÙˆØ¹ Ø¨Ù†Ø²ÙŠÙ† ØªØ­ØªØ§Ø¬ØŸ</label>
          <select id="fuelTypeSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†</option>
            <option value="premium">Ø¨Ù†Ø²ÙŠÙ† Ù…Ù…ØªØ§Ø² (1.5 Ø¯.Ùƒ)</option>
            <option value="special">Ø¨Ù†Ø²ÙŠÙ† Ø®ØµÙˆØµÙŠ (1.5 Ø¯.Ùƒ)</option>
            <option value="ultra">Ø¨Ù†Ø²ÙŠÙ† Ø§Ù„ØªØ±Ø§ (2.5 Ø¯.Ùƒ)</option>
          </select>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], () => {
        document.getElementById('fuelTypeContainer').classList.remove('hidden');
        
        const fuelTypeSelect = document.getElementById('fuelTypeSelect');
        fuelTypeSelect.addEventListener('change', () => {
          formData.fuelType = fuelTypeSelect.value;
          if (formData.fuelType) {
            calculateAndShowResult();
          }
        });
      });
    }

    // Render Tire Fields
    function renderTireFields() {
      const html = `
        <div>
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6, 8, 9, 10, 12, 13, 14], calculateAndShowResult);
    }

    // Render Balance Fields
    function renderBalanceFields() {
      const html = `
        <div>
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„ØªÙˆØ§ÙŠØ± Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§ Ø£Ùˆ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ØŸ</label>
          <select id="tireSourceSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…ØµØ¯Ø±</option>
            <option value="ours">Ù…Ù† Ø¹Ù†Ø¯Ù†Ø§</option>
            <option value="customer">Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„</option>
          </select>
        </div>
        
        <div id="balanceAreaContainer" class="hidden">
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
        
        <div id="tireCountContainer" class="hidden">
          <label for="tireCountInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±</label>
          <input 
            type="number" 
            id="tireCountInput" 
            min="1" 
            max="10" 
            class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
            placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±"
          >
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      
      const tireSourceSelect = document.getElementById('tireSourceSelect');
      tireSourceSelect.addEventListener('change', () => {
        formData.tireSource = tireSourceSelect.value;
        
        if (!formData.tireSource) {
          document.getElementById('balanceAreaContainer').classList.add('hidden');
          document.getElementById('tireCountContainer').classList.add('hidden');
          resultsSection.classList.add('hidden');
          return;
        }
        
        document.getElementById('balanceAreaContainer').classList.remove('hidden');
        
        if (formData.tireSource === 'ours') {
          document.getElementById('tireCountContainer').classList.add('hidden');
          initAreaAutocomplete('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [0, 1, 2, 4, 5, 6], calculateAndShowResult);
        } else {
          document.getElementById('tireCountContainer').classList.remove('hidden');
          initAreaAutocomplete('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [8, 9, 10, 12, 13, 14], () => {
            const tireCountInput = document.getElementById('tireCountInput');
            tireCountInput.addEventListener('input', () => {
              formData.tireCount = parseInt(tireCountInput.value) || 0;
              if (formData.tireCount > 0) {
                calculateAndShowResult();
              }
            });
          });
        }
      });
    }

    // Render Mechanical Fields
    function renderMechanicalFields() {
      const html = `
        <div>
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</label>
          <select id="mechanicalServiceSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©</option>
            <option value="inspection">ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</option>
            <option value="oil">Ø²ÙŠØª ÙˆÙÙ„ØªØ± (Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø¹Ù†Ø¯Ù‡ Ø§Ù„Ø²ÙŠØª)</option>
            <option value="brakes">Ø³ÙØ§ÙŠÙ ÙˆØ¯ÙŠØ³ÙƒØ§Øª</option>
          </select>
        </div>
        
        <div id="mechanicalAreaContainer" class="hidden">
          <label for="areaInput" class="block text-lg font-semibold text-gray-900 mb-2">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©</label>
          <div class="relative">
            <input 
              type="text" 
              id="areaInput" 
              class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
              placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©..."
              autocomplete="off"
            >
            <div id="areaSuggestions" class="absolute z-10 w-full mt-1 hidden autocomplete-list"></div>
          </div>
        </div>
        
        <div id="diskTurningContainer" class="hidden">
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ù‡Ù„ ØªØ±ÙŠØ¯ Ù…Ø®Ø±Ø·Ø© Ø¯ÙŠØ³ÙƒØ§ØªØŸ</label>
          <select id="diskTurningSelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="no">Ù„Ø§</option>
            <option value="yes">Ù†Ø¹Ù… (+5 Ø¯.Ùƒ)</option>
          </select>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      
      const mechanicalServiceSelect = document.getElementById('mechanicalServiceSelect');
      mechanicalServiceSelect.addEventListener('change', () => {
        formData.mechanicalService = mechanicalServiceSelect.value;
        
        if (!formData.mechanicalService) {
          document.getElementById('mechanicalAreaContainer').classList.add('hidden');
          document.getElementById('diskTurningContainer').classList.add('hidden');
          resultsSection.classList.add('hidden');
          return;
        }
        
        // Reset area input when service changes
        const areaInput = document.getElementById('areaInput');
        if (areaInput) {
          areaInput.value = '';
          formData.area = '';
        }
        
        document.getElementById('mechanicalAreaContainer').classList.remove('hidden');
        resultsSection.classList.add('hidden');
        
        if (formData.mechanicalService === 'inspection') {
          document.getElementById('diskTurningContainer').classList.add('hidden');
          initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [0, 1, 2, 4, 5, 6], calculateAndShowResult);
        } else if (formData.mechanicalService === 'oil') {
          document.getElementById('diskTurningContainer').classList.add('hidden');
          initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [8, 9, 10, 12, 13, 14], calculateAndShowResult);
        } else if (formData.mechanicalService === 'brakes') {
          document.getElementById('diskTurningContainer').classList.remove('hidden');
          initAreaAutocomplete('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', [16, 17, 18, 20, 21, 22], () => {
            const diskTurningSelect = document.getElementById('diskTurningSelect');
            formData.diskTurning = 'no';
            diskTurningSelect.addEventListener('change', () => {
              formData.diskTurning = diskTurningSelect.value;
              calculateAndShowResult();
            });
            calculateAndShowResult();
          });
        }
      });
    }

    // Render Car Wash Fields
    function renderCarWashFields() {
      const html = `
        <div>
          <label class="block text-lg font-semibold text-gray-900 mb-2">Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</label>
          <select id="washQualitySelect" class="w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold">
            <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„</option>
            <option value="premium">Ù…Ù…ØªØ§Ø² ÙÙ‚Ø·</option>
            <option value="special">Ø®ØµÙˆØµÙŠ ÙÙ‚Ø·</option>
            <option value="ultra">Ø£Ù„ØªØ±Ø§ ÙÙ‚Ø·</option>
            <option value="all">Ø§Ù„ÙƒÙ„</option>
          </select>
        </div>
        
        <div id="washCardsContainer" class="hidden">
          <div class="space-y-4 mt-6" id="washCards">
            <!-- Cards will be inserted here -->
          </div>
        </div>
        
        <div id="appointmentContainer" class="hidden">
          <label for="appointmentDate" class="block text-lg font-semibold text-gray-900 mb-2 mt-6">Ø§Ø®ØªØ± ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
          <input 
            type="date" 
            id="appointmentDate" 
            class="date-input w-full px-4 py-3 border-2 border-gold rounded-lg text-lg focus:outline-none focus:ring-2 focus:ring-gold"
          >
          <div id="availableSlots" class="mt-4"></div>
        </div>
      `;
      
      dynamicFields.innerHTML = html;
      
      const washQualitySelect = document.getElementById('washQualitySelect');
      const washCardsContainer = document.getElementById('washCardsContainer');
      const washCards = document.getElementById('washCards');
      
      washQualitySelect.addEventListener('change', () => {
        const quality = washQualitySelect.value;
        
        if (!quality) {
          washCardsContainer.classList.add('hidden');
          document.getElementById('appointmentContainer').classList.add('hidden');
          formData.selectedWashes = [];
          return;
        }
        
        // Generate wash cards based on selection
        washCards.innerHTML = '';
        
        if (quality === 'premium' || quality === 'all') {
          washCards.innerHTML += `
            <div class="wash-card">
              <div class="flex justify-between items-start mb-3">
                <h3>â­ ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²</h3>
                <div class="text-sm bg-green-100 text-green-800 px-3 py-1 rounded-full font-semibold">1 Ø³Ø§Ø¹Ø©</div>
              </div>
              <div class="price mb-4">ØµØ§Ù„ÙˆÙ†: 7 Ø¯.Ùƒ | Ø¬ÙŠØ¨: 8 Ø¯.Ùƒ</div>
              <div id="premiumDetails">
                <div class="bg-gray-50 rounded-lg p-4 mb-3">
                  <p class="font-semibold mb-2 text-gray-800">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:</p>
                  <ul class="space-y-1">
                    <li>ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</li>
                    <li>ØªÙ†Ø¸ÙŠÙ Ø¯Ø§Ø®Ù„ÙŠ</li>
                    <li>ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª</li>
                    <li>ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ</li>
                    <li>Ø¹Ø·Ø±</li>
                  </ul>
                </div>
                <button type="button" class="copy-btn" onclick="copyWashText('premium')">
                  ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
              </div>
            </div>
          `;
        }
        
        if (quality === 'special' || quality === 'all') {
          washCards.innerHTML += `
            <div class="wash-card">
              <div class="flex justify-between items-start mb-3">
                <h3>ğŸ’ ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ</h3>
                <div class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded-full font-semibold">Ø³Ø§Ø¹ØªÙŠÙ†</div>
              </div>
              <div class="price mb-4">ØµØ§Ù„ÙˆÙ†: 15 Ø¯.Ùƒ | Ø¬ÙŠØ¨: 17 Ø¯.Ùƒ</div>
              <div id="specialDetails">
                <div class="bg-gray-50 rounded-lg p-4 mb-3">
                  <p class="font-semibold mb-2 text-gray-800">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:</p>
                  <ul class="space-y-1">
                    <li>ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</li>
                    <li>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</li>
                    <li>ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</li>
                    <li>Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹ Ø§Ù„Ø®ÙÙŠÙØ© Ù…Ù† Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
                    <li>ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª</li>
                    <li>ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ</li>
                    <li>Ø¹Ø·Ø±</li>
                  </ul>
                </div>
                <button type="button" class="copy-btn" onclick="copyWashText('special')">
                  ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
              </div>
            </div>
          `;
        }
        
        if (quality === 'ultra' || quality === 'all') {
          washCards.innerHTML += `
            <div class="wash-card">
              <div class="flex justify-between items-start mb-3">
                <h3>ğŸ‘‘ ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§</h3>
                <div class="text-sm bg-purple-100 text-purple-800 px-3 py-1 rounded-full font-semibold">3 Ø³Ø§Ø¹Ø§Øª</div>
              </div>
              <div class="price mb-4">ØµØ§Ù„ÙˆÙ†: 30 Ø¯.Ùƒ | Ø¬ÙŠØ¨: 35 Ø¯.Ùƒ</div>
              <div id="ultraDetails">
                <div class="bg-gray-50 rounded-lg p-4 mb-3">
                  <p class="font-semibold mb-2 text-gray-800">Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:</p>
                  <ul class="space-y-1">
                    <li>ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ</li>
                    <li>Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ</li>
                    <li>ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©</li>
                    <li>ØºØ³ÙŠÙ„ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
                    <li>ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨</li>
                    <li>ØºØ³ÙŠÙ„ Ø¯Ø¨Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©</li>
                    <li>ØªÙ†Ø¸ÙŠÙ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</li>
                  </ul>
                </div>
                <button type="button" class="copy-btn" onclick="copyWashText('ultra')">
                  ğŸ“‹ Ù†Ø³Ø® Ø§Ù„ØªÙØ§ØµÙŠÙ„
                </button>
              </div>
            </div>
          `;
        }
        
        // Store selected washes
        if (quality === 'premium') {
          formData.selectedWashes = ['premium'];
        } else if (quality === 'special') {
          formData.selectedWashes = ['special'];
        } else if (quality === 'ultra') {
          formData.selectedWashes = ['ultra'];
        } else {
          formData.selectedWashes = ['premium', 'special', 'ultra'];
        }
        
        washCardsContainer.classList.remove('hidden');
        document.getElementById('appointmentContainer').classList.remove('hidden');
        
        // Set up appointment date and auto-refresh
        setTimeout(() => {
          const appointmentDate = document.getElementById('appointmentDate');
          if (appointmentDate) {
            const today = new Date().toISOString().split('T')[0];
            appointmentDate.min = today;
            appointmentDate.value = today;
            
            loadCarWashAppointments(today);
            
            appointmentDate.addEventListener('change', () => {
              loadCarWashAppointments(appointmentDate.value);
            });
            
            // Auto-refresh every 30 seconds
            const refreshInterval = setInterval(() => {
              // Only refresh if still on car wash service
              if (currentService === 'carwash' && appointmentDate && appointmentDate.value) {
                loadCarWashAppointments(appointmentDate.value);
              } else {
                clearInterval(refreshInterval);
              }
            }, 30000); // 30 seconds
          }
        }, 100);
      });
    }

    // Copy wash text function
    window.copyWashText = async function(type) {
      const washDetails = {
        premium: {
          name: 'ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø²',
          duration: 'Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©',
          priceSedan: 7,
          priceSUV: 8,
          services: [
            'ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ',
            'ØªÙ†Ø¸ÙŠÙ Ø¯Ø§Ø®Ù„ÙŠ',
            'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª',
            'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ',
            'Ø¹Ø·Ø±'
          ]
        },
        special: {
          name: 'ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ',
          duration: 'Ø³Ø§Ø¹ØªÙŠÙ†',
          priceSedan: 15,
          priceSUV: 17,
          services: [
            'ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ',
            'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ',
            'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©',
            'Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¨Ù‚Ø¹ Ø§Ù„Ø®ÙÙŠÙØ© Ù…Ù† Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
            'ØªÙ„Ù…ÙŠØ¹ Ø§Ù„ØªÙˆØ§ÙŠØ± ÙˆØ§Ù„Ø±Ù†Ù‚Ø§Øª',
            'ØªÙ†Ø¸ÙŠÙ ÙØªØ­Ø§Øª Ø§Ù„ØªÙƒÙŠÙŠÙ',
            'Ø¹Ø·Ø±'
          ]
        },
        ultra: {
          name: 'ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§',
          duration: '3 Ø³Ø§Ø¹Ø§Øª',
          priceSedan: 30,
          priceSUV: 35,
          services: [
            'ØºØ³ÙŠÙ„ Ø®Ø§Ø±Ø¬ÙŠ',
            'Ø§Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ',
            'ØªÙ„Ù…ÙŠØ¹ Ø¯ÙŠÙƒÙˆØ±Ø§Øª Ø§Ù„Ø³ÙŠØ§Ø±Ø© Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠØ©',
            'ØºØ³ÙŠÙ„ Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
            'ØªÙ†Ø¸ÙŠÙ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨',
            'ØºØ³ÙŠÙ„ Ø¯Ø¨Ø© Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
            'ØªÙ†Ø¸ÙŠÙ Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©'
          ]
        }
      };
      
      const wash = washDetails[type];
      if (!wash) return;
      
      const text = `
${wash.name}
Ù…Ø¯Ø© Ø§Ù„ØºØ³ÙŠÙ„: ${wash.duration}

Ø§Ù„Ø£Ø³Ø¹Ø§Ø±:
â€¢ ØµØ§Ù„ÙˆÙ†: ${wash.priceSedan} Ø¯.Ùƒ
â€¢ Ø¬ÙŠØ¨: ${wash.priceSUV} Ø¯.Ùƒ

Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…Ø´Ù…ÙˆÙ„Ø©:
${wash.services.map(s => `â€¢ ${s}`).join('\n')}
      `.trim();
      
      try {
        await navigator.clipboard.writeText(text);
        
        // Find the button and show success
        const buttons = document.querySelectorAll('.copy-btn');
        buttons.forEach(btn => {
          if (btn.onclick && btn.onclick.toString().includes(type)) {
            const originalText = btn.innerHTML;
            btn.classList.add('copy-success');
            btn.innerHTML = 'âœ“ ØªÙ… Ø§Ù„Ù†Ø³Ø®!';
            
            setTimeout(() => {
              btn.classList.remove('copy-success');
              btn.innerHTML = originalText;
            }, 2000);
          }
        });
      } catch (err) {
        console.error('Failed to copy:', err);
      }
    };

    // Load car wash appointments
    async function loadCarWashAppointments(selectedDate) {
      try {
        const sheetId = '1FkWKRxRFC8UG1Ez2VzYHadHju2HARBLbdTIsr57hKXc';
        const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Sheet1`;
        
        const response = await fetch(csvUrl);
        if (!response.ok) {
          throw new Error('Failed to load appointments');
        }
        
        const csvText = await response.text();
        const rows = parseCSV(csvText);
        
        carWashData = [];
        
        // Parse appointments (skip header row)
        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          if (row[0] && row[1]) { // Date and Time columns
            // Parse date from various formats (MM/DD/YYYY or other formats)
            let parsedDate = row[0].trim();
            
            // Try to parse the date
            const dateObj = new Date(parsedDate);
            if (!isNaN(dateObj.getTime())) {
              // Convert to YYYY-MM-DD format for consistent comparison
              const year = dateObj.getFullYear();
              const month = String(dateObj.getMonth() + 1).padStart(2, '0');
              const day = String(dateObj.getDate()).padStart(2, '0');
              parsedDate = `${year}-${month}-${day}`;
            }
            
            // Parse time - handle both 12-hour (with AM/PM) and 24-hour formats
            let timeStr = row[1].trim();
            let hours = 0;
            let minutes = 0;
            
            // Check if time contains AM/PM
            const hasAMPM = /am|pm/i.test(timeStr);
            
            if (hasAMPM) {
              const isPM = /pm/i.test(timeStr);
              // Remove AM/PM and any extra spaces
              timeStr = timeStr.replace(/am|pm/gi, '').trim();
              
              const timeParts = timeStr.split(':');
              hours = parseInt(timeParts[0]) || 0;
              minutes = parseInt(timeParts[1]) || 0;
              
              // Convert to 24-hour format
              if (isPM && hours !== 12) {
                hours += 12;
              } else if (!isPM && hours === 12) {
                hours = 0;
              }
            } else {
              // Already 24-hour format or just parse as-is
              const timeParts = timeStr.split(':');
              hours = parseInt(timeParts[0]) || 0;
              minutes = parseInt(timeParts[1]) || 0;
            }
            
            const formattedTime = `${hours}:${String(minutes).padStart(2, '0')}`;
            
            carWashData.push({
              date: parsedDate,
              time: formattedTime,
              qrOrder: row[2] || '',
              customerName: row[3] || '',
              customerNumber: row[4] || '',
              customerLocation: row[5] || '',
              washType: row[6] || '',
              payment: row[7] || ''
            });
          }
        }
        
        calculateAvailableSlots(selectedDate);
        
      } catch (error) {
        console.error('Error loading car wash appointments:', error);
        document.getElementById('availableSlots').innerHTML = `
          <div class="info-box" style="background: #fee2e2; border-color: #fca5a5; color: #991b1b;">
            Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.
          </div>
        `;
      }
    }

    // Calculate available slots
    function calculateAvailableSlots(selectedDate) {
      const availableSlots = document.getElementById('availableSlots');
      
      // Parse selected date
      const dateObj = new Date(selectedDate + 'T00:00:00');
      const dayOfWeek = dateObj.toLocaleDateString('ar-EG', { weekday: 'long' });
      const formattedDate = dateObj.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
      
      // Check if Friday
      const dayIndex = dateObj.getDay(); // 0 = Sunday, 5 = Friday
      
      // Calculate week number of the year
      const startOfYear = new Date(dateObj.getFullYear(), 0, 1);
      const days = Math.floor((dateObj - startOfYear) / (24 * 60 * 60 * 1000));
      const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
      
      // Check if Friday and odd week (closed)
      if (dayIndex === 5 && weekNumber % 2 === 1) {
        // Friday on odd week - CLOSED
        const nextSaturday = new Date(dateObj);
        nextSaturday.setDate(nextSaturday.getDate() + 1);
        const saturdayFormatted = nextSaturday.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
        
        availableSlots.innerHTML = `
          <div class="card p-6" style="border: 3px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);">
            <p class="text-2xl font-bold mb-3" style="color: #991b1b;">âŒ Ù…ØºÙ„Ù‚ ÙŠÙˆÙ… Ø§Ù„Ø¬Ù…Ø¹Ø©</p>
            <p class="text-lg" style="color: #7f1d1d;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª ${saturdayFormatted}</p>
          </div>
        `;
        return;
      }
      
      // Filter appointments for selected date
      const todayAppointments = carWashData.filter(apt => {
        return apt.date === selectedDate;
      });
      
      // Sort by time
      todayAppointments.sort((a, b) => {
        const timeA = a.time.split(':').map(Number);
        const timeB = b.time.split(':').map(Number);
        return (timeA[0] * 60 + timeA[1]) - (timeB[0] * 60 + timeB[1]);
      });
      
      let html = `
        <div class="card p-6 mb-4">
          <h3 class="text-2xl font-bold mb-2" style="color: #F2BC1B; text-shadow: 1px 1px 2px rgba(0,0,0,0.2);">${dayOfWeek}</h3>
          <p class="text-lg text-gray-700 font-semibold">${formattedDate}</p>
        </div>
      `;
      
      // Working hours: 10:30 AM to 10:00 PM (630 minutes to 1320 minutes)
      const workStartMinutes = 630; // 10:30 AM
      const workEndMinutes = 1320; // 10:00 PM
      
      // Calculate next available time starting from 10:30 AM
      let nextAvailableTime = workStartMinutes;
      
      // Check if selected date is today
      const today = new Date();
      const isToday = dateObj.getDate() === today.getDate() && 
                      dateObj.getMonth() === today.getMonth() && 
                      dateObj.getFullYear() === today.getFullYear();
      
      // If today, consider current time
      if (isToday) {
        const currentMinutes = today.getHours() * 60 + today.getMinutes();
        // Round up to next 5-minute interval and add 30 minutes buffer
        const roundedMinutes = Math.ceil((currentMinutes + 30) / 5) * 5;
        nextAvailableTime = Math.max(nextAvailableTime, roundedMinutes);
      }
      
      if (todayAppointments.length === 0) {
        // Check if there's enough time for selected wash types
        const availableWashTypes = getAvailableWashTypes(nextAvailableTime, workEndMinutes);
        
        // Convert next available time to display format
        const hours = Math.floor(nextAvailableTime / 60);
        const minutes = nextAvailableTime % 60;
        const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
        const displayHours = hours > 12 ? hours - 12 : hours;
        const displayTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        
        if (availableWashTypes.length === 0) {
          // No time for any wash - suggest next day
          const nextDay = getNextAvailableDay(dateObj);
          html += `
            <div class="card p-6 mb-4" style="border: 3px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);">
              <p class="text-2xl font-bold mb-3" style="color: #991b1b;">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª ÙƒØ§ÙÙ Ø§Ù„ÙŠÙˆÙ…</p>
              <p class="text-lg mb-2" style="color: #7f1d1d;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 Ù…Ø³Ø§Ø¡Ù‹</p>
              <p class="text-lg font-bold" style="color: #7f1d1d;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ${nextDay}</p>
            </div>
          `;
        } else if (availableWashTypes.length < formData.selectedWashes.length) {
          // Partial availability
          html += `
            <div class="card p-6 mb-4" style="border: 3px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <div class="mb-4">
                <p class="text-2xl font-bold mb-2" style="color: #92400e;">â° ÙˆÙ‚Øª Ù…Ø­Ø¯ÙˆØ¯ Ù…ØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ…</p>
                <p class="text-lg mb-2" style="color: #78350f;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯: <span class="font-bold">${displayTime}</span></p>
                <p class="text-base" style="color: #78350f;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 Ù…Ø³Ø§Ø¡Ù‹</p>
              </div>
              
              <div class="mb-3">
                <p class="text-lg font-bold mb-2" style="color: #92400e;">âœ“ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„ÙŠÙˆÙ…:</p>
                <ul class="space-y-1" style="color: #78350f;">
                  ${availableWashTypes.map(type => `<li class="text-base">â€¢ ${type}</li>`).join('')}
                </ul>
              </div>
              
              <div class="mt-3 pt-3" style="border-top: 2px solid #f59e0b;">
                <p class="text-lg font-bold mb-1" style="color: #92400e;">Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</p>
                <p class="text-base" style="color: #78350f;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ${getNextAvailableDay(dateObj)}</p>
              </div>
            </div>
          `;
        } else {
          // Full availability
          html += `
            <div class="card p-6 mb-4" style="border: 3px solid #16a34a; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">âœ“</span>
                  <span class="text-xl font-bold text-green-700">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­</span>
                </div>
                <span class="text-3xl font-bold" style="color: #1a1a1a;">${displayTime}</span>
              </div>
              <p class="text-gray-700 text-lg">${isToday ? 'Ù…ØªØ§Ø­ Ø§Ù„Ø¢Ù†' : `Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¹ÙŠØ¯ Ù…Ø­Ø¬ÙˆØ²Ø© ${dayOfWeek} - Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ‚Ø§Øª Ù…ØªØ§Ø­Ø© Ù…Ù† 10:30 ØµØ¨Ø§Ø­Ø§Ù‹`}</p>
            </div>
          `;
        }
      } else {
        // Calculate next available slot considering appointments and current time
        for (let i = 0; i < todayAppointments.length; i++) {
          const apt = todayAppointments[i];
          const timeParts = apt.time.split(':').map(Number);
          let appointmentMinutes = timeParts[0] * 60 + timeParts[1];
          
          // Determine wash duration
          let washDuration = 0;
          const washType = apt.washType.toLowerCase();
          if (washType.includes('Ù…Ù…ØªØ§Ø²') || washType.includes('premium')) {
            washDuration = 60; // 1 hour
          } else if (washType.includes('Ø®ØµÙˆØµÙŠ') || washType.includes('special')) {
            washDuration = 120; // 2 hours
          } else if (washType.includes('Ø§Ù„ØªØ±Ø§') || washType.includes('ultra')) {
            washDuration = 180; // 3 hours
          } else {
            washDuration = 60; // default
          }
          
          // End time = appointment time + wash duration + 30 min travel time for next appointment
          const endTime = appointmentMinutes + washDuration + 30;
          
          // Update next available time
          if (endTime > nextAvailableTime) {
            nextAvailableTime = endTime;
          }
        }
        
        // Round to next 5-minute interval (never use :10, :40 etc)
        const remainder = nextAvailableTime % 5;
        if (remainder !== 0) {
          nextAvailableTime = nextAvailableTime + (5 - remainder);
        }
        
        // Check if there's enough time for selected wash types
        const availableWashTypes = getAvailableWashTypes(nextAvailableTime, workEndMinutes);
        
        // Convert next available time to hours and minutes
        const hours = Math.floor(nextAvailableTime / 60);
        const minutes = nextAvailableTime % 60;
        const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
        const displayHours = hours > 12 ? hours - 12 : hours;
        const displayTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
        
        if (availableWashTypes.length === 0) {
          // No time for any wash - suggest next day
          const nextDay = getNextAvailableDay(dateObj);
          html += `
            <div class="card p-6 mb-6" style="border: 3px solid #dc2626; background: linear-gradient(135deg, #fee2e2 0%, #fca5a5 100%);">
              <p class="text-2xl font-bold mb-3" style="color: #991b1b;">âš ï¸ Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆÙ‚Øª ÙƒØ§ÙÙ Ø§Ù„ÙŠÙˆÙ…</p>
              <p class="text-lg mb-2" style="color: #7f1d1d;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 Ù…Ø³Ø§Ø¡Ù‹</p>
              <p class="text-lg font-bold" style="color: #7f1d1d;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ${nextDay}</p>
            </div>
          `;
        } else if (availableWashTypes.length < formData.selectedWashes.length) {
          // Partial availability
          html += `
            <div class="card p-6 mb-6" style="border: 3px solid #f59e0b; background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);">
              <div class="mb-4">
                <p class="text-2xl font-bold mb-2" style="color: #92400e;">â° ÙˆÙ‚Øª Ù…Ø­Ø¯ÙˆØ¯ Ù…ØªØ§Ø­ Ø§Ù„ÙŠÙˆÙ…</p>
                <p class="text-lg mb-2" style="color: #78350f;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯: <span class="font-bold">${displayTime}</span></p>
                <p class="text-base" style="color: #78350f;">Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¹Ù…Ù„ ØªÙ†ØªÙ‡ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø© 10:00 Ù…Ø³Ø§Ø¡Ù‹</p>
              </div>
              
              <div class="mb-3">
                <p class="text-lg font-bold mb-2" style="color: #92400e;">âœ“ Ø®Ø¯Ù…Ø§Øª Ø§Ù„ØºØ³ÙŠÙ„ Ø§Ù„Ù…ØªØ§Ø­Ø© Ø§Ù„ÙŠÙˆÙ…:</p>
                <ul class="space-y-1" style="color: #78350f;">
                  ${availableWashTypes.map(type => `<li class="text-base">â€¢ ${type}</li>`).join('')}
                </ul>
              </div>
              
              <div class="mt-3 pt-3" style="border-top: 2px solid #f59e0b;">
                <p class="text-lg font-bold mb-1" style="color: #92400e;">Ù„Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰:</p>
                <p class="text-base" style="color: #78350f;">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­: ${getNextAvailableDay(dateObj)}</p>
              </div>
            </div>
          `;
        } else {
          // Full availability
          html += `
            <div class="card p-6 mb-6" style="border: 3px solid #16a34a; background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);">
              <div class="flex justify-between items-center mb-3">
                <div class="flex items-center gap-3">
                  <span class="text-3xl">âœ“</span>
                  <span class="text-xl font-bold text-green-700">Ø£Ù‚Ø±Ø¨ Ù…ÙˆØ¹Ø¯ Ù…ØªØ§Ø­</span>
                </div>
                <span class="text-3xl font-bold" style="color: #1a1a1a;">${displayTime}</span>
              </div>
              <p class="text-gray-700 text-lg">${isToday ? 'Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…ØªØ§Ø­' : 'Ø§Ù„Ù…ÙˆØ¹Ø¯ Ø§Ù„ØªØ§Ù„ÙŠ Ø§Ù„Ù…ØªØ§Ø­ Ø¨Ø¹Ø¯ Ø§Ù†ØªÙ‡Ø§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠØ©'}</p>
            </div>
          `;
        }
        
        html += `
          <div class="mb-4">
            <h4 class="text-xl font-bold mb-4" style="color: #1a1a1a;">Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¬ÙˆØ²Ø© Ø§Ù„ÙŠÙˆÙ…:</h4>
          </div>
        `;
        
        // Display all appointments
        todayAppointments.forEach((apt, index) => {
          const timeParts = apt.time.split(':').map(Number);
          const hours = timeParts[0];
          const minutes = timeParts[1];
          const period = hours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
          const displayHours = hours > 12 ? hours - 12 : hours;
          const displayTime = `${displayHours}:${minutes.toString().padStart(2, '0')} ${period}`;
          
          // Calculate end time
          let washDuration = 0;
          const washType = apt.washType.toLowerCase();
          if (washType.includes('Ù…Ù…ØªØ§Ø²') || washType.includes('premium')) {
            washDuration = 60;
          } else if (washType.includes('Ø®ØµÙˆØµÙŠ') || washType.includes('special')) {
            washDuration = 120;
          } else if (washType.includes('Ø§Ù„ØªØ±Ø§') || washType.includes('ultra')) {
            washDuration = 180;
          }
          
          const startMinutes = hours * 60 + minutes;
          const endMinutes = startMinutes + washDuration;
          const endHours = Math.floor(endMinutes / 60);
          const endMins = endMinutes % 60;
          const endPeriod = endHours >= 12 ? 'Ù…Ø³Ø§Ø¡Ù‹' : 'ØµØ¨Ø§Ø­Ø§Ù‹';
          const endDisplayHours = endHours > 12 ? endHours - 12 : endHours;
          const endDisplayTime = `${endDisplayHours}:${endMins.toString().padStart(2, '0')} ${endPeriod}`;
          
          const washDurationText = washDuration === 60 ? '1 Ø³Ø§Ø¹Ø©' : washDuration === 120 ? 'Ø³Ø§Ø¹ØªÙŠÙ†' : '3 Ø³Ø§Ø¹Ø§Øª';
          
          html += `
            <div class="card p-5 mb-3" style="border: 2px solid #F2BC1B;">
              <div class="flex justify-between items-start mb-3">
                <div>
                  <div class="flex items-center gap-2 mb-1">
                    <span class="text-2xl font-bold" style="color: #1a1a1a;">${displayTime}</span>
                    <span class="text-gray-600">â†’</span>
                    <span class="text-xl font-semibold text-gray-700">${endDisplayTime}</span>
                  </div>
                  <span class="text-sm font-semibold px-3 py-1 rounded-full inline-block" style="background: #F2BC1B; color: #1a1a1a;">${washDurationText}</span>
                </div>
                <span class="text-base font-bold px-4 py-2 rounded-lg" style="background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #F2BC1B;">${apt.washType}</span>
              </div>
              ${apt.customerName ? `<p class="text-gray-700 text-lg mb-1"><span class="font-semibold">Ø§Ù„Ø¹Ù…ÙŠÙ„:</span> ${apt.customerName}</p>` : ''}
              ${apt.customerNumber ? `<p class="text-gray-700 text-lg mb-1"><span class="font-semibold">Ø§Ù„Ø±Ù‚Ù…:</span> ${apt.customerNumber}</p>` : ''}
              ${apt.customerLocation ? `<p class="text-gray-700 text-lg"><span class="font-semibold">Ø§Ù„Ù…ÙˆÙ‚Ø¹:</span> ${apt.customerLocation}</p>` : ''}
            </div>
          `;
        });
      }
      
      availableSlots.innerHTML = html;
    }
    
    // Get available wash types based on arrival time
    function getAvailableWashTypes(startMinutes, endMinutes) {
      const availableTypes = [];
      
      // Premium (1 hour): last arrival 9:00 PM = 21:00 = 1260 minutes
      // Special (2 hours): last arrival 8:00 PM = 20:00 = 1200 minutes  
      // Ultra (3 hours): last arrival 7:00 PM = 19:00 = 1140 minutes
      
      if (startMinutes <= 1260) { // 9:00 PM
        availableTypes.push('ØºØ³ÙŠÙ„ Ù…Ù…ØªØ§Ø² (1 Ø³Ø§Ø¹Ø©)');
      }
      if (startMinutes <= 1200) { // 8:00 PM
        availableTypes.push('ØºØ³ÙŠÙ„ Ø®ØµÙˆØµÙŠ (Ø³Ø§Ø¹ØªÙŠÙ†)');
      }
      if (startMinutes <= 1140) { // 7:00 PM
        availableTypes.push('ØºØ³ÙŠÙ„ Ø£Ù„ØªØ±Ø§ (3 Ø³Ø§Ø¹Ø§Øª)');
      }
      
      return availableTypes;
    }
    
    // Get next available day (skipping closed Fridays)
    function getNextAvailableDay(currentDate) {
      const nextDay = new Date(currentDate);
      nextDay.setDate(nextDay.getDate() + 1);
      
      // Check if next day is Friday
      const dayIndex = nextDay.getDay();
      
      // Calculate week number for Friday check
      const startOfYear = new Date(nextDay.getFullYear(), 0, 1);
      const days = Math.floor((nextDay - startOfYear) / (24 * 60 * 60 * 1000));
      const weekNumber = Math.ceil((days + startOfYear.getDay() + 1) / 7);
      
      // If Friday and odd week, skip to Saturday
      if (dayIndex === 5 && weekNumber % 2 === 1) {
        nextDay.setDate(nextDay.getDate() + 1);
      }
      
      const dayName = nextDay.toLocaleDateString('ar-EG', { weekday: 'long' });
      const formattedDate = nextDay.toLocaleDateString('ar-EG', { year: 'numeric', month: 'long', day: 'numeric' });
      
      return `ÙŠÙˆÙ… ${dayName} ${formattedDate}`;
    }

    // Initialize Area Autocomplete
    function initAreaAutocomplete(sheetName, columns, callback) {
      const areaInput = document.getElementById('areaInput');
      const areaSuggestions = document.getElementById('areaSuggestions');
      
      if (!sheetsData[sheetName]) {
        showError('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©');
        return;
      }
      
      const rows = sheetsData[sheetName];
      const areas = [];
      
      // Collect unique areas from specified columns
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        columns.forEach((colIndex, idx) => {
          if (idx % 3 === 0 && row[colIndex]) { // Area columns
            areas.push(row[colIndex]);
          }
        });
      }
      
      const uniqueAreas = [...new Set(areas)].filter(Boolean);
      
      areaInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase().trim();
        
        if (!searchTerm) {
          areaSuggestions.classList.add('hidden');
          formData.area = '';
          resultsSection.classList.add('hidden');
          return;
        }
        
        const matches = uniqueAreas.filter(area => area.toLowerCase().includes(searchTerm));
        
        if (matches.length === 0) {
          areaSuggestions.classList.add('hidden');
          return;
        }
        
        areaSuggestions.innerHTML = '';
        matches.forEach(area => {
          const div = document.createElement('div');
          div.className = 'autocomplete-item';
          div.textContent = area;
          div.addEventListener('click', () => {
            areaInput.value = area;
            formData.area = area;
            areaSuggestions.classList.add('hidden');
            
            if (callback) {
              callback();
            }
          });
          areaSuggestions.appendChild(div);
        });
        
        areaSuggestions.classList.remove('hidden');
        
        const exactMatch = uniqueAreas.find(a => a.toLowerCase() === searchTerm);
        if (exactMatch) {
          formData.area = exactMatch;
          if (callback) {
            callback();
          }
        }
      });
      
      // Show all suggestions on click
      areaInput.addEventListener('click', () => {
        if (uniqueAreas.length > 0) {
          areaSuggestions.innerHTML = '';
          uniqueAreas.forEach(area => {
            const div = document.createElement('div');
            div.className = 'autocomplete-item';
            div.textContent = area;
            div.addEventListener('click', () => {
              areaInput.value = area;
              formData.area = area;
              areaSuggestions.classList.add('hidden');
              
              if (callback) {
                callback();
              }
            });
            areaSuggestions.appendChild(div);
          });
          areaSuggestions.classList.remove('hidden');
        }
      });
      
      document.addEventListener('click', (e) => {
        if (!areaSuggestions.contains(e.target) && e.target !== areaInput) {
          areaSuggestions.classList.add('hidden');
        }
      });
    }

    // Calculate and Show Result
    function calculateAndShowResult() {
      showError('');
      loadingSpinner.classList.remove('hidden');
      
      setTimeout(() => {
        try {
          let result;
          
          switch(currentService) {
            case 'tow':
              result = calculateTowPrice();
              break;
            case 'battery':
              result = calculateServicePrice('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], 'Ø§Ø´ØªØ±Ø§Ùƒ Ø¨Ø·Ø§Ø±ÙŠØ© - ÙØ­Øµ Ø¨Ø·Ø§Ø±ÙŠØ©');
              break;
            case 'batteryInstall':
              result = calculateBatteryInstallPrice();
              break;
            case 'fuel':
              result = calculateFuelPrice();
              break;
            case 'tire':
              result = calculateTirePrice();
              break;
            case 'balance':
              result = calculateBalancePrice();
              break;
            case 'mechanical':
              result = calculateMechanicalPrice();
              break;
          }
          
          if (result) {
            displayResult(result);
          }
          
        } catch (error) {
          showError(error.message);
        } finally {
          loadingSpinner.classList.add('hidden');
        }
      }, 300);
    }

    // Calculate Tow Price
    function calculateTowPrice() {
      const routes = getTowRoutes(formData.company, formData.towType);
      const route = routes.find(r => r.from === formData.from && r.to === formData.to);
      
      if (!route) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯');
      }
      
      let price = parseFloat(route.price) || 0;
      
      // Add extra charges if applicable (portarage only)
      const extraCharges = (formData.company && formData.company.toLowerCase() === 'portarage towtruk' && formData.extraCharges === 'yes') ? 10 : 0;
      
      // Get cancellation fee for portarage
      let cancellationFee = null;
      if (formData.company.toLowerCase() === 'portarage towtruk') {
        const rows = sheetsData['portarage towtruk'];
        if (rows && rows.length > 2) {
          for (let i = 2; i < rows.length; i++) {
            const row = rows[i];
            
            if (formData.towType === 'normal') {
              const from = row[6];
              const toF = row[5];
              const toC = row[2];
              const priceE = row[4];
              const priceB = row[1];
              
              if (from === formData.from) {
                if (toF === formData.to && priceE && parseFloat(priceE) === price) {
                  cancellationFee = row[3];
                  break;
                } else if (toC === formData.to && priceB && parseFloat(priceB) === price) {
                  cancellationFee = row[0];
                  break;
                }
              }
            } else if (formData.towType === 'flatbed') {
              const from = row[14];
              const toN = row[13];
              const toK = row[10];
              const priceM = row[12];
              const priceJ = row[9];
              
              if (from === formData.from) {
                if (toN === formData.to && priceM && parseFloat(priceM) === price) {
                  cancellationFee = row[11];
                  break;
                } else if (toK === formData.to && priceJ && parseFloat(priceJ) === price) {
                  cancellationFee = row[8];
                  break;
                }
              }
            }
          }
        }
      }
      
      const result = {
        title: formData.companyArabic || formData.company,
        table: {
          headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ø³Ø¹Ø±'],
          rows: [
            [`Ø³Ø¹Ø± ${formData.companyArabic || formData.company}`, `${price.toFixed(2)} ${config.currency}`]
          ]
        }
      };
      
      // Add extra charges row if applicable
      if (extraCharges > 0) {
        const total = price + extraCharges;
        result.table.rows.push(
          ['Ø±Ø³ÙˆÙ… Ø¹Ø±Ø¨Ø§Ù†Ø§Øª (Ù‚ÙŠØ± Ù…Ø§ ÙŠØªØ¨ÙˆØ´/Ø­Ø§Ø¯Ø«)', `${extraCharges.toFixed(2)} ${config.currency}`],
          ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${total.toFixed(2)} ${config.currency}`]
        );
      }
      
      // If portarage towtruk, show cancellation fee
      if (formData.company.toLowerCase() === 'portarage towtruk') {
        result.table.rows.push(['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', cancellationFee ? `${parseFloat(cancellationFee).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']);
      }
      // If not portarage, compare with portarage price
      else if (sheetsData['portarage towtruk']) {
        const portarageRoutes = getTowRoutes('portarage towtruk', formData.towType);
        const portarageRoute = portarageRoutes.find(r => r.from === formData.from && r.to === formData.to);
        
        if (portarageRoute) {
          const originalPrice = parseFloat(portarageRoute.price) || 0;
          const discount = originalPrice - price;
          
          result.table.rows.push(
            ['Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ø£ØµÙ„ÙŠ (Ø¨ÙˆØ±ØªØ±Ø§Ø¬)', `${originalPrice.toFixed(2)} ${config.currency}`],
            ['Ø§Ù„Ø®ØµÙ…', `${discount.toFixed(2)} ${config.currency}`]
          );
        }
      }
      
      return result;
    }

    // Calculate Service Price (Generic)
    function calculateServicePrice(sheetName, columns, serviceName) {
      const rows = sheetsData[sheetName];
      if (!rows || rows.length < 3) {
        throw new Error('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©');
      }
      
      let price = null;
      let cancellation = null;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        // Check first section
        if (row[columns[0]] === formData.area) {
          price = row[columns[1]];
          cancellation = row[columns[2]];
          break;
        }
        
        // Check second section
        if (columns.length > 3 && row[columns[3]] === formData.area) {
          price = row[columns[4]];
          cancellation = row[columns[5]];
          break;
        }
      }
      
      if (!price) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
      }
      
      return {
        title: serviceName,
        table: {
          headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
          rows: [
            ['Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©', `${parseFloat(price).toFixed(2)} ${config.currency}`],
            ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', cancellation ? `${parseFloat(cancellation).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']
          ]
        }
      };
    }

    // Calculate Fuel Price
    function calculateFuelPrice() {
      const baseResult = calculateServicePrice('Ø®Ø¯Ù…Ø§Øª5', [0, 1, 2, 4, 5, 6], 'Ø®Ø¯Ù…Ø© Ø¨Ù†Ø²ÙŠÙ†');
      
      const servicePrice = parseFloat(baseResult.table.rows[0][1]);
      const fuelPrices = {
        'premium': 1.5,
        'special': 1.5,
        'ultra': 2.5
      };
      const fuelPrice = fuelPrices[formData.fuelType] || 1.5;
      const total = servicePrice + fuelPrice;
      
      const fuelTypes = {
        'premium': 'Ø¨Ù†Ø²ÙŠÙ† Ù…Ù…ØªØ§Ø²',
        'special': 'Ø¨Ù†Ø²ÙŠÙ† Ø®ØµÙˆØµÙŠ',
        'ultra': 'Ø¨Ù†Ø²ÙŠÙ† Ø§Ù„ØªØ±Ø§'
      };
      
      baseResult.table.rows = [
        ['Ø±Ø³ÙˆÙ… Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙˆØµÙŠÙ„', `${servicePrice.toFixed(2)} ${config.currency}`],
        ['Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†', fuelTypes[formData.fuelType]],
        ['Ø³Ø¹Ø± Ø§Ù„Ø¨Ù†Ø²ÙŠÙ†', `${fuelPrice.toFixed(2)} ${config.currency}`],
        ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${total.toFixed(2)} ${config.currency}`],
        ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', baseResult.table.rows[1][1]]
      ];
      
      baseResult.note = 'Ù…Ù„Ø§Ø­Ø¸Ø© : Ù„Ø§Ø²Ù… ØªØ´Ø±Ø­ÙˆÙ† Ù„Ù„Ø¹Ù…ÙŠÙ„ Ø§Ù†Ù‡ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ù‡ Ø¬Ù… ÙˆØ³Ø¹Ø± Ø§Ù„Ø¨Ù†Ø²ÙŠÙ† Ø¬Ù… ÙˆØ§Ù†Ù‡ ÙŠÙˆØµÙ„Ù‡ Ù„Ø§Ù‚Ø±Ø¨ Ù…Ø­Ø·Ù‡ ÙÙ‚Ø·';
      
      return baseResult;
    }

    // Calculate Battery Install Price
    function calculateBatteryInstallPrice() {
      const result = calculateServicePrice('ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©', [0, 1, 2, 4, 5, 6], 'ØªØ±ÙƒÙŠØ¨ Ø¨Ø·Ø§Ø±ÙŠØ©');
      result.note = 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ù‡Ø°Ø§ Ø§Ù„Ø³Ø¹Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ Ø§Ù„Ø¨Ø·Ø§Ø±ÙŠØ© Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„';
      return result;
    }

    // Calculate Tire Price
    function calculateTirePrice() {
      const rows = sheetsData['Ø®Ø¯Ù…Ø§Øª5'];
      if (!rows || rows.length < 3) {
        throw new Error('Ù„Ù… ÙŠØªÙ… ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø®Ø¯Ù…Ø©');
      }
      
      let externalPrice = null, externalCancel = null;
      let internalPrice = null, internalCancel = null;
      
      for (let i = 2; i < rows.length; i++) {
        const row = rows[i];
        
        // External patch (columns A, B, C or E, F, G)
        if (row[0] === formData.area) {
          externalPrice = row[1];
          externalCancel = row[2];
        } else if (row[4] === formData.area) {
          externalPrice = row[5];
          externalCancel = row[6];
        }
        
        // Internal patch (columns I, J, K or M, N, O)
        if (row[8] === formData.area) {
          internalPrice = row[9];
          internalCancel = row[10];
        } else if (row[12] === formData.area) {
          internalPrice = row[13];
          internalCancel = row[14];
        }
      }
      
      if (!externalPrice && !internalPrice) {
        throw new Error('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø¹Ø± Ù„Ù„Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©');
      }
      
      return {
        title: 'Ø®Ø¯Ù…Ø© Ø¨Ù†Ø´Ø±',
        tables: [
          {
            title: 'Ø±Ù‚Ø¹Ø© Ø®Ø§Ø±Ø¬ÙŠØ© / ØªØ±ÙƒÙŠØ¨ Ø³Ø¨ÙŠØ± / ØªØ¹Ø¨Ø¦Ø© Ù‡ÙˆØ§Ø¡',
            headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
            rows: [
              ['Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©', externalPrice ? `${parseFloat(externalPrice).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'],
              ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', externalCancel ? `${parseFloat(externalCancel).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']
            ]
          },
          {
            title: 'Ø±Ù‚Ø¹Ø© Ø¯Ø§Ø®Ù„ÙŠØ©',
            headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
            rows: [
              ['Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø©', internalPrice ? `${parseFloat(internalPrice).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…ØªÙˆÙØ±'],
              ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', internalCancel ? `${parseFloat(internalCancel).toFixed(2)} ${config.currency}` : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯']
            ]
          }
        ]
      };
    }

    // Calculate Balance Price
    function calculateBalancePrice() {
      if (formData.tireSource === 'ours') {
        const result = calculateServicePrice('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [0, 1, 2, 4, 5, 6], 'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨');
        result.note = 'Ù…Ù„Ø§Ø­Ø¸Ø© : Ø§Ù„Ø³Ø¹Ø± Ù‡Ø°Ø§ Ø³ÙˆØ§Ø¡ Ø¨ÙŠØ±ÙƒØ¨ Ù…Ù† ØªØ§ÙŠØ± Ø§Ù„Ù‰ Ø§Ø±Ø¨Ø¹ ØªÙˆØ§ÙŠØ± Ù†ÙØ³ Ø±Ø³ÙˆÙ… Ø§Ù„Ø®Ø¯Ù…Ù‡';
        return result;
      } else {
        const baseResult = calculateServicePrice('Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨', [8, 9, 10, 12, 13, 14], 'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨');
        const basePrice = parseFloat(baseResult.table.rows[0][1]);
        const tireCount = formData.tireCount;
        const total = basePrice + (tireCount * 5);
        
        return {
          title: 'Ù…ÙŠØ²Ø§Ù† ÙˆØªØ±ÙƒÙŠØ¨',
          tables: [
            {
              title: 'ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©',
              headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
              rows: [
                ['Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', `${basePrice.toFixed(2)} ${config.currency}`],
                ['Ø¹Ø¯Ø¯ Ø§Ù„ØªÙˆØ§ÙŠØ±', tireCount],
                ['Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙˆØ§ÙŠØ± (5 Ø¯.Ùƒ Ã— ' + tireCount + ')', `${(tireCount * 5).toFixed(2)} ${config.currency}`],
                ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${total.toFixed(2)} ${config.currency}`]
              ]
            },
            {
              title: 'Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
              headers: ['Ø§Ù„ØªÙØ§ØµÙŠÙ„', 'Ø§Ù„Ù‚ÙŠÙ…Ø©'],
              rows: [
                ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', baseResult.table.rows[1][1]]
              ]
            }
          ],
          note: `Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„`
        };
      }
    }

    // Calculate Mechanical Price
    function calculateMechanicalPrice() {
      const serviceNames = {
        'inspection': 'ÙØ­Øµ Ø§Ù„Ø³ÙŠØ§Ø±Ø©',
        'oil': 'Ø²ÙŠØª ÙˆÙÙ„ØªØ±',
        'brakes': 'Ø³ÙØ§ÙŠÙ ÙˆØ¯ÙŠØ³ÙƒØ§Øª'
      };
      
      let columns;
      let serviceName = serviceNames[formData.mechanicalService];
      
      if (formData.mechanicalService === 'inspection') {
        columns = [0, 1, 2, 4, 5, 6];
      } else if (formData.mechanicalService === 'oil') {
        columns = [8, 9, 10, 12, 13, 14];
      } else {
        columns = [16, 17, 18, 20, 21, 22];
      }
      
      const result = calculateServicePrice('Ø®Ø¯Ù…Ø§Øª Ù…ÙŠÙƒØ§Ù†ÙŠÙƒÙŠØ©', columns, serviceName);
      
      if (formData.mechanicalService === 'oil') {
        result.note = 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ù„Ø²ÙŠØª ÙˆØ§Ù„ÙÙ„ØªØ± Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„ ÙÙ‚Ø·';
      }
      
      if (formData.mechanicalService === 'brakes') {
        result.note = 'Ù…Ù„Ø§Ø­Ø¸Ø©: Ø¥Ø°Ø§ Ø§Ù„Ù‚Ø·Ø¹ Ù…Ù† Ø¹Ù†Ø¯ Ø§Ù„Ø¹Ù…ÙŠÙ„';
        
        if (formData.diskTurning === 'yes') {
          const basePrice = parseFloat(result.table.rows[0][1]);
          const total = basePrice + 5;
          
          result.table.rows = [
            ['Ø³Ø¹Ø± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ', `${basePrice.toFixed(2)} ${config.currency}`],
            ['Ù…Ø®Ø±Ø·Ø© Ø¯ÙŠØ³ÙƒØ§Øª', `5.00 ${config.currency}`],
            ['Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ', `${total.toFixed(2)} ${config.currency}`],
            ['Ø±Ø³ÙˆÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡', result.table.rows[1][1]]
          ];
        }
      }
      
      return result;
    }

    // Display Result
    function displayResult(result) {
      resultTitle.textContent = result.title;
      
      let html = '';
      
      // Single table
      if (result.table) {
        html += `
          <table class="result-table">
            <thead>
              <tr>
                ${result.table.headers.map(h => `<th>${h}</th>`).join('')}
              </tr>
            </thead>
            <tbody>
              ${result.table.rows.map(row => `
                <tr>
                  ${row.map(cell => `<td>${cell}</td>`).join('')}
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;
      }
      
      // Multiple tables
      if (result.tables) {
        result.tables.forEach(table => {
          html += `
            <div class="mb-4">
              <h3 class="text-lg font-bold text-gray-800 mb-2 text-center">${table.title}</h3>
              <table class="result-table">
                <thead>
                  <tr>
                    ${table.headers.map(h => `<th>${h}</th>`).join('')}
                  </tr>
                </thead>
                <tbody>
                  ${table.rows.map(row => `
                    <tr>
                      ${row.map(cell => `<td>${cell}</td>`).join('')}
                    </tr>
                  `).join('')}
                </tbody>
              </table>
            </div>
          `;
        });
      }
      
      if (result.note) {
        html += `<div class="info-box">${result.note}</div>`;
      }
      
      resultContent.innerHTML = html;
      resultsSection.classList.remove('hidden');
      
      setTimeout(() => {
        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    }

    // Helper Functions
    function showError(message) {
      if (message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove('hidden');
      } else {
        errorMessage.classList.add('hidden');
      }
    }

    // Initial load
    loadAllSheets();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9b27ecf297c551ca',t:'MTc2NjQ5MzYwNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
